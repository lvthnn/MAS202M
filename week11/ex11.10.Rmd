---
title: Exercise 11.10
date: April 2024
output: html_document
author: KÃ¡ri Hlynsson
---

This exercise focuses on the brain tumour data, which is included in the
`ISLR2` `R` library.

## Part (a)
Plot the Kaplan-Meier survival curve with \(\pm 1\) standard error bands,
using the `survfit()` function in the `survival` package.

Import the data:

```{r message = FALSE}
library(ISLR2)
data(BrainCancer)
attach(BrainCancer)
```

Fit the Kaplan-Meier survival curve:

```{r}
library(survival)

surv_fit <- survfit(Surv(time, status) ~ 1)
plot(
  surv_fit,
  xlab = "Time (Months)",
  ylab = "Estimated probability of survival"
)
```

## Part(b)
Draw a bootstrap sample of size \(n = 88\) from the pairs \((y_i, \delta_i)\),
and compute the resulting Kaplan-Meier survival curve. Repeat this process
\(B = 200\) times. Use the results to obtain an estimate of the standard error
of the Kaplan-Meier survival curve at each timepoint. Compare this to the
standard errors obtained in (a).

```{r}
set.seed(1)

n <- 88
b <- 200

df_survfit <- data.frame()

for (i in 1:b) {
  sel <- sample(1:n, n, replace = TRUE)
  boot <- BrainCancer[sel, ]

  boot_surv <- Surv(boot$time, boot$status)
  boot_survfit <- survfit(boot_surv ~ 1)

  boot_data <- data.frame(
    time = summary(boot_survfit)$time,
    surv = summary(boot_survfit)$surv
  )

  df_survfit <- rbind(df_survfit, boot_data)
}
```

The `df_survfit` data frame contains the data we need.

```{r}
library(dplyr)

se_est <- df_survfit |>
  group_by(time) |>
  summarise(
    se_fit = sd(surv)
  )
```

Now let's compare the estimates:

```{r}
se_cmp <- data.frame(
  time = se_est$time,
  se_boot = se_est$se_fit,
  se_surv = summary(surv_fit)$std.err
)

plot(
  se_cmp$se_boot,
  se_cmp$se_surv,
  xlab = "Bootstrap SE",
  ylab = "Survfit SE"
)

abline(0, 1, lty = 2)
```

They are virtually identical!

## Part (c)
Fit a Cox proportional hazards models that uses all of the predictors to
predict survival. Summarise the main findings.

```{r}
cox_fit <- coxph(
  Surv(time, status) ~ sex + diagnosis + loc + ki + gtv + stereo
)

summary(cox_fit)
```

## Part (d)
Stratify the data by the value of `ki`. (Since only one observation has
`ki = 40`, you can group that observation together with the observations that
`ki = 60`.) Plot Kaplan-Meier survival curves for each of the five strata,
adjusted for the other predictors.

```{r}
modaldata <- data.frame(
  diagnosis = rep("Meningioma", 5),
  sex = rep("Female", 5),
  loc = rep("Supratentorial", 5),
  ki = c(60, 70, 80, 90, 100),
  gtv = rep(mean(gtv), 5),
  stereo = rep("SRT", 5)
)

survplots <- survfit(cox_fit, newdata = modaldata)
cut_legend <- cut(
  ki,
  breaks = seq(40, 100, by = 10)[-2],
  include.lowest = TRUE
)

plot(
  survplots,
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  col = 2:6,
  lwd = 2.25
)

legend(
  "bottomleft",
  bty = "n",
  legend = levels(cut_legend),
  col = 2:6,
  lwd = 2.25
)
```
